/*
    https://protobuf.dev/programming-guides/proto3/ 
*/
syntax = "proto3";

package api;


service QgisServer {
    rpc Ping (PingRequest) returns (PingReply) {}
    rpc ExecuteOwsRequest (OwsRequest) returns (stream ResponseChunk) {}
    rpc ExecuteRequest (GenericRequest) returns (stream ResponseChunk) {}
}

service QgisAdmin {
    rpc Ping (PingRequest) returns (PingReply) {}
    rpc CheckoutProject (CheckoutRequest) returns (stream CacheInfo) {}
    rpc PullProjects (stream ProjectRequest) returns (stream CacheInfo) {}
    rpc DropProject (DropRequest) returns (stream CacheInfo) {}
    rpc ListCache (ListRequest) returns (stream CacheInfo) {}
    rpc ClearCache (Empty) returns (Empty) {}
    rpc UpdateCache (Empty) returns (stream CacheInfo) {}
    rpc ListPlugins (Empty) returns (stream PluginInfo) {}
    rpc SetConfig (JsonConfig) returns (Empty) {}
    rpc GetConfig (Empty) returns (JsonConfig) {}
    rpc GetProjectInfo (ProjectRequest) returns (stream ProjectInfo) {}
    rpc Catalog (CatalogRequest) returns (stream CatalogItem) {}
    rpc GetEnv (Empty) returns (JsonConfig) {}
    rpc SetServerServingStatus (ServerStatus) returns (Empty) {}
    rpc Stats (Empty) returns (StatsReply) {}
}


message PingRequest {
    string echo = 1;
}


message PingReply {
    string echo = 1;
}


message Empty {}


enum ServingStatus {
    SERVING = 0;
    NOT_SERVING = 1;
}

message StatsReply {
    int32 num_workers = 2;
    int32 stopped_workers = 3;
    float worker_failure_pressure = 4;
    float request_pressure = 5;
    int32 uptime = 6;
}

message ServerStatus {
    ServingStatus status = 1;
}


message ResponseChunk {
    bytes chunk = 1;
}

message OwsRequest {
    string service = 1;
    string request = 2;
    string target = 3;
    optional string version = 4;
    optional string url = 5;
    optional bool direct = 6;
    optional string options = 7;
    optional string request_id = 8;
    optional bool debug_report = 9;
}

message GenericRequest {
    string url = 1;
    string method = 2;
    optional bytes data = 3;
    optional string target = 4;
    optional string version = 5;
    optional bool direct = 6;
    optional string request_id = 7;
    optional bool debug_report = 9;
}

message CheckoutRequest {
    string uri = 1;
    optional bool pull = 2;
}

message CacheInfo {
    string uri = 1;
    string status = 2;
    bool in_cache = 3;
    optional string name = 4;
    optional string storage = 5;
    optional string last_modified = 6;
    optional string saved_version = 7;
    map<string,int64> debug_metadata = 8;
    optional string cache_id = 9;
}

message DropRequest {
    string uri = 1;
}

message ListRequest {
    optional string status_filter = 1;
}

message ProjectRequest {        
    string uri = 1;
}

message ProjectInfo {
    message Layer {
        string layer_id = 1;
        string name = 2;
        string source = 3;
        string crs = 4;
        bool is_valid = 5;
        bool is_spatial = 6;
    } 
    string status = 1;
    string uri = 2;
    string filename = 3;
    string crs = 4;
    string last_modified = 5;
    string storage = 6;
    bool has_bad_layers = 7;
    repeated Layer layers = 8;
    optional string cache_id = 9;
}

message PluginInfo {
    string name = 1;
    string path = 2;
    string plugin_type = 3;
    string json_metadata = 4;
}

message JsonConfig {
    string json = 1;
}

message CatalogRequest {
    optional string location = 1;
}

message CatalogItem {
    string uri = 1;
    string name = 2;
    string storage = 3;
    string last_modified = 4;
    string public_uri = 5;
}
